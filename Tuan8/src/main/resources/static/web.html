<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GraphQL Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { display: flex; gap: 20px; align-items: flex-start; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); flex: 1; }
        h2 { border-bottom: 1px solid #ddd; padding-bottom: 10px; color: #333; }
        button { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin: 2px; }
        button.delete { background-color: #dc3545; }
        button.edit { background-color: #ffc107; color: black; }
        button:hover { opacity: 0.8; }
        input { width: calc(100% - 18px); padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 10px; }
        .item { border-bottom: 1px solid #eee; padding: 8px 0; }
        .item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<h1>GraphQL Dashboard</h1>

<div class="container">
    <div class="panel">
        <h2>Products</h2>
        <h4>Sorted by Price</h4>
        <div id="products-sorted-list"></div>
        <hr>
        <h4>Products by Category</h4>
        <input type="text" id="catIdInput" placeholder="Enter Category ID">
        <button onclick="fetchProductsByCategory()">Find</button>
        <div id="products-by-cat-list"></div>
    </div>

    <div class="panel">
        <h2>Users</h2>
        <div id="users-list"></div>
        <hr>
        <h3>Manage User</h3>
        <input type="hidden" id="userId">
        <input type="text" id="userName" placeholder="Full Name">
        <input type="email" id="userEmail" placeholder="Email">
        <input type="text" id="userPhone" placeholder="Phone">
        <button id="user-submit-button" onclick="handleUserSubmit()">Add User</button>
        <button id="user-cancel-button" style="display:none; background-color: #6c757d;" onclick="resetUserForm()">Cancel</button>
    </div>

    <div class="panel">
        <h2>Categories</h2>
        <div id="categories-list"></div>
        <hr>
        <h3>Manage Category</h3>
        <input type="hidden" id="catId">
        <input type="text" id="catName" placeholder="Category Name">
        <button id="cat-submit-button" onclick="handleCategorySubmit()">Add Category</button>
        <button id="cat-cancel-button" style="display:none; background-color: #6c757d;" onclick="resetCategoryForm()">Cancel</button>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/graphql';

    // Hàm gọi GraphQL API chung
    async function callGraphQL(query, variables = {}) {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, variables })
        });
        return await response.json();
    }

    // Hàm render danh sách chung
    function renderList(elementId, items, renderFunc) {
        const listDiv = document.getElementById(elementId);
        listDiv.innerHTML = '';
        if (!items || items.length === 0) {
            listDiv.innerHTML = '<p>No data found.</p>';
            return;
        }
        items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            itemDiv.innerHTML = renderFunc(item);
            listDiv.appendChild(itemDiv);
        });
    }

    // --- PRODUCTS ---
    async function fetchSortedProducts() {
        const query = `query { productsSortedByPrice { id title price user { fullname } category { name } } }`;
        const result = await callGraphQL(query);
        renderList('products-sorted-list', result.data.productsSortedByPrice, (p) =>
            `<strong>${p.title}</strong> - $${p.price}<br><small>By ${p.user.fullname} in ${p.category.name}</small>`
        );
    }

    async function fetchProductsByCategory() {
        const categoryId = document.getElementById('catIdInput').value;
        if (!categoryId) return;
        const query = `query ProductsByCategory($catId: ID!) { productsByCategory(categoryId: $catId) { id title price } }`;
        const result = await callGraphQL(query, { catId: categoryId });
        renderList('products-by-cat-list', result.data.productsByCategory, (p) =>
            `<strong>${p.title}</strong> - $${p.price}`
        );
    }

    // --- USERS ---
    async function fetchUsers() {
        const query = `query { allUsers { id fullname email phone } }`;
        const result = await callGraphQL(query);
        renderList('users-list', result.data.allUsers, (u) =>
            `<strong>${u.fullname}</strong> (${u.email || 'N/A'})
             <div>
                <button class="edit" onclick="editUser('${u.id}', '${u.fullname}', '${u.email}', '${u.phone || ''}')">Edit</button>
                <button class="delete" onclick="deleteUser(${u.id})">Delete</button>
             </div>`
        );
    }

    function editUser(id, fullname, email, phone) {
        document.getElementById('userId').value = id;
        document.getElementById('userName').value = fullname;
        document.getElementById('userEmail').value = email;
        document.getElementById('userPhone').value = phone;
        document.getElementById('user-submit-button').innerText = 'Update User';
        document.getElementById('user-cancel-button').style.display = 'inline-block';
    }

    function resetUserForm() {
        document.getElementById('userId').value = '';
        document.getElementById('userName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPhone').value = '';
        document.getElementById('user-submit-button').innerText = 'Add User';
        document.getElementById('user-cancel-button').style.display = 'none';
    }

    async function handleUserSubmit() {
        const id = document.getElementById('userId').value;
        const input = {
            fullname: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            phone: document.getElementById('userPhone').value,
            password: "123" // Mật khẩu mặc định khi thêm/sửa
        };

        if (id) {
            const mutation = `mutation UpdateUser($id: ID!, $input: UserInput!) { updateUser(id: $id, input: $input) { id } }`;
            await callGraphQL(mutation, { id, input });
        } else {
            const mutation = `mutation CreateUser($input: UserInput!) { createUser(input: $input) { id } }`;
            await callGraphQL(mutation, { input });
        }
        resetUserForm();
        fetchUsers();
    }

    async function deleteUser(id) {
        if (!confirm('Are you sure you want to delete this user?')) return;
        const mutation = `mutation DeleteUser($id: ID!) { deleteUser(id: $id) }`;
        await callGraphQL(mutation, { id });
        fetchUsers();
    }

    // --- CATEGORIES (Tương tự Users) ---
    async function fetchCategories() {
        const query = `query { allCategories { id name } }`;
        const result = await callGraphQL(query);
        renderList('categories-list', result.data.allCategories, (c) =>
            `<strong>ID: ${c.id}</strong> - ${c.name}
             <div>
                <button class="edit" onclick="editCategory('${c.id}', '${c.name}')">Edit</button>
                <button class="delete" onclick="deleteCategory(${c.id})">Delete</button>
             </div>`
        );
    }

    function editCategory(id, name) {
        document.getElementById('catId').value = id;
        document.getElementById('catName').value = name;
        document.getElementById('cat-submit-button').innerText = 'Update Category';
        document.getElementById('cat-cancel-button').style.display = 'inline-block';
    }

    function resetCategoryForm() {
        document.getElementById('catId').value = '';
        document.getElementById('catName').value = '';
        document.getElementById('cat-submit-button').innerText = 'Add Category';
        document.getElementById('cat-cancel-button').style.display = 'none';
    }

    async function handleCategorySubmit() {
        const id = document.getElementById('catId').value;
        const input = { name: document.getElementById('catName').value, images: "" };

        if (id) {
            const mutation = `mutation UpdateCategory($id: ID!, $input: CategoryInput!) { updateCategory(id: $id, input: $input) { id } }`;
            await callGraphQL(mutation, { id, input });
        } else {
            const mutation = `mutation CreateCategory($input: CategoryInput!) { createCategory(input: $input) { id } }`;
            await callGraphQL(mutation, { input });
        }
        resetCategoryForm();
        fetchCategories();
    }

    async function deleteCategory(id) {
        if (!confirm('Are you sure? Deleting a category may affect products.')) return;
        const mutation = `mutation DeleteCategory($id: ID!) { deleteCategory(id: $id) }`;
        await callGraphQL(mutation, { id });
        fetchCategories();
    }

    // Tải dữ liệu ban đầu
    window.onload = () => {
        fetchSortedProducts();
        fetchUsers();
        fetchCategories();
    };
</script>

</body>
</html>