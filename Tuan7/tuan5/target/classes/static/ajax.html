<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang Quản Trị AJAX</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .icon-preview { max-width: 50px; max-height: 50px; border-radius: 4px; object-fit: cover; }
        body { padding-bottom: 5rem; }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center mb-4">Trang Quản Trị (Category & Product)</h1>
    <hr>

    <div class="row g-5">
        <div class="col-md-8">
            <h3>Danh sách Danh mục</h3>
            <table class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên</th>
                    <th>Hình ảnh</th>
                    <th style="width: 150px;">Hành động</th>
                </tr>
                </thead>
                <tbody id="category-table-body"></tbody>
            </table>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header"><h5 id="category-form-title">Thêm Danh mục</h5></div>
                <div class="card-body">
                    <form id="category-form">
                        <input type="hidden" id="categoryId">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Tên Danh mục</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryIcon" class="form-label">Icon</label>
                            <input type="file" class="form-control" id="categoryIcon">
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                        <button type="button" class="btn btn-secondary" id="category-cancel-btn" style="display: none;">Hủy</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="row g-5">
        <div class="col-md-8">
            <h3>Danh sách Sản phẩm</h3>
            <table class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên</th>
                    <th>SL</th>
                    <th>Giá</th>
                    <th>Danh mục</th>
                    <th>Ảnh</th>
                    <th style="width: 150px;">Hành động</th>
                </tr>
                </thead>
                <tbody id="product-table-body"></tbody>
            </table>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header"><h5 id="product-form-title">Thêm Sản phẩm</h5></div>
                <div class="card-body">
                    <form id="product-form">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Tên Sản phẩm</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Số lượng</label>
                            <input type="number" class="form-control" id="quantity" required>
                        </div>
                        <div class="mb-3">
                            <label for="unitPrice" class="form-label">Đơn giá</label>
                            <input type="number" step="0.01" class="form-control" id="unitPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">Danh mục</label>
                            <select id="productCategory" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="productImages" class="form-label">Hình ảnh</label>
                            <input type="file" class="form-control" id="productImages">
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                        <button type="button" class="btn btn-secondary" id="product-cancel-btn" style="display: none;">Hủy</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CATEGORY_API_URL = '/api/category';
    const PRODUCT_API_URL = '/api/product';

    // ==========================================
    // LOGIC CHO CATEGORY
    // ==========================================
    const categoryForm = document.getElementById('category-form');
    const categoryIdField = document.getElementById('categoryId');
    const categoryNameField = document.getElementById('categoryName');
    const categoryIconField = document.getElementById('categoryIcon');
    const categoryFormTitle = document.getElementById('category-form-title');
    const categoryCancelBtn = document.getElementById('category-cancel-btn');

    async function loadCategories() {
        try {
            const response = await fetch(CATEGORY_API_URL);
            const result = await response.json();

            const tableBody = document.getElementById('category-table-body');
            const categorySelect = document.getElementById('productCategory');
            tableBody.innerHTML = '';
            categorySelect.innerHTML = '<option value="">-- Chọn danh mục --</option>';

            if (result.status) {
                result.body.forEach(cat => {
                    const row = `<tr>
                        <td>${cat.id}</td>
                        <td>${cat.categoryName}</td>
                        <td><img src="/images/${cat.images || 'default.png'}" class="icon-preview"></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editCategory(${cat.id}, '${cat.categoryName}')">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">Xóa</button>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;

                    const option = `<option value="${cat.id}">${cat.categoryName}</option>`;
                    categorySelect.innerHTML += option;
                });
            } else {
                alert('Lỗi tải danh mục: ' + result.message);
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    categoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('categoryName', categoryNameField.value);
        if (categoryIconField.files[0]) {
            formData.append('icon', categoryIconField.files[0]);
        }

        const id = categoryIdField.value;
        let url = CATEGORY_API_URL + '/addCategory';
        let method = 'POST';

        if (id) {
            url = CATEGORY_API_URL + '/updateCategory';
            method = 'PUT';
            formData.append('categoryId', id);
        }

        try {
            const response = await fetch(url, { method, body: formData });
            const result = await response.json();
            alert(result.message);
            if (result.status) {
                resetCategoryForm();
                await loadCategories();
                await loadProducts();
            }
        } catch (error) {
             console.error('Error saving category:', error);
        }
    });

    function editCategory(id, name) {
        categoryIdField.value = id;
        categoryNameField.value = name;
        categoryFormTitle.textContent = 'Cập nhật Danh mục';
        categoryCancelBtn.style.display = 'inline-block';
        categoryForm.scrollIntoView({ behavior: 'smooth' });
    }

    async function deleteCategory(id) {
        if (!confirm('Xóa danh mục này sẽ xóa tất cả sản phẩm liên quan. Bạn chắc chắn?')) return;

        const formData = new FormData();
        formData.append('categoryId', id);

        try {
            const response = await fetch(CATEGORY_API_URL + '/deleteCategory', { method: 'DELETE', body: formData });
            const result = await response.json();
            alert(result.message);
            if (result.status) {
                await loadCategories();
                await loadProducts();
            }
        } catch(error) {
            console.error('Error deleting category:', error);
        }
    }

    function resetCategoryForm() {
        categoryForm.reset();
        categoryIdField.value = '';
        categoryFormTitle.textContent = 'Thêm Danh mục mới';
        categoryCancelBtn.style.display = 'none';
    }
    categoryCancelBtn.addEventListener('click', resetCategoryForm);

    // ==========================================
    // LOGIC CHO PRODUCT
    // ==========================================
    const productForm = document.getElementById('product-form');
    const productIdField = document.getElementById('productId');
    const productNameField = document.getElementById('productName');
    const quantityField = document.getElementById('quantity');
    const unitPriceField = document.getElementById('unitPrice');
    const productCategoryField = document.getElementById('productCategory');
    const productImagesField = document.getElementById('productImages');
    const productFormTitle = document.getElementById('product-form-title');
    const productCancelBtn = document.getElementById('product-cancel-btn');

    async function loadProducts() {
        try {
            const response = await fetch(PRODUCT_API_URL);
            const result = await response.json();
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '';

            if (result.status) {
                result.body.forEach(prod => {
                    const categoryName = prod.category ? prod.category.categoryName : 'Chưa có';
                    const row = `<tr>
                        <td>${prod.id}</td>
                        <td>${prod.productName}</td>
                        <td>${prod.quantity}</td>
                        <td>${new Intl.NumberFormat('vi-VN').format(prod.unitPrice)} đ</td>
                        <td>${categoryName}</td>
                        <td><img src="/images/${prod.images || 'default.png'}" class="icon-preview"></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick='editProduct(${JSON.stringify(prod)})'>Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${prod.id})">Xóa</button>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            } else {
                 alert('Lỗi tải sản phẩm: ' + result.message);
            }
        } catch(error) {
            console.error('Error loading products:', error);
        }
    }

    productForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('productName', productNameField.value);
        formData.append('quantity', quantityField.value);
        formData.append('unitPrice', unitPriceField.value);
        formData.append('categoryId', productCategoryField.value);
        if (productImagesField.files[0]) {
            formData.append('images', productImagesField.files[0]);
        }

        const id = productIdField.value;
        let url = PRODUCT_API_URL + '/addProduct';
        let method = 'POST';

        if (id) {
            url = PRODUCT_API_URL + '/updateProduct';
            method = 'PUT';
            formData.append('productId', id);
        }

        try {
            const response = await fetch(url, { method, body: formData });
            const result = await response.json();
            alert(result.message);
            if (result.status) {
                resetProductForm();
                await loadProducts();
            }
        } catch(error) {
            console.error('Error saving product:', error);
        }
    });

    function editProduct(product) {
        productIdField.value = product.id;
        productNameField.value = product.productName;
        quantityField.value = product.quantity;
        unitPriceField.value = product.unitPrice;
        productCategoryField.value = product.category ? product.category.id : '';
        productFormTitle.textContent = 'Cập nhật Sản phẩm';
        productCancelBtn.style.display = 'inline-block';
        productForm.scrollIntoView({ behavior: 'smooth' });
    }

    async function deleteProduct(id) {
        if (!confirm('Bạn có chắc muốn xóa sản phẩm này không?')) return;

        const formData = new FormData();
        formData.append('productId', id);

        try {
            const response = await fetch(PRODUCT_API_URL + '/deleteProduct', { method: 'DELETE', body: formData });
            const result = await response.json();
            alert(result.message);
            if (result.status) {
                await loadProducts();
            }
        } catch(error) {
            console.error('Error deleting product:', error);
        }
    }

    function resetProductForm() {
        productForm.reset();
        productIdField.value = '';
        productFormTitle.textContent = 'Thêm Sản phẩm mới';
        productCancelBtn.style.display = 'none';
    }
    productCancelBtn.addEventListener('click', resetProductForm);

    // Tải tất cả dữ liệu khi trang được mở
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCategories();
        await loadProducts();
    });
</script>
</body>
</html>