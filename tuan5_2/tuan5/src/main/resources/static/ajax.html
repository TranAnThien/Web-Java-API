<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Danh mục</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .icon-preview {
            max-width: 50px;
            max-height: 50px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>Quản lý Danh mục</h2>

    <div class="card mb-4">
        <div class="card-header">
            <h5 id="form-title">Thêm Danh mục mới</h5>
        </div>
        <div class="card-body">
            <form id="category-form">
                <input type="hidden" id="categoryId">

                <div class="mb-3">
                    <label for="categoryName" class="form-label">Tên Danh mục</label>
                    <input type="text" class="form-control" id="categoryName" required>
                </div>

                <div class="mb-3">
                    <label for="icon" class="form-label">Icon/Hình ảnh</label>
                    <input type="file" class="form-control" id="icon">
                </div>

                <button type="submit" class="btn btn-primary">Lưu</button>
                <button type="button" class="btn btn-secondary" id="cancel-btn" style="display: none;">Hủy</button>
            </form>
        </div>
    </div>

    <h3>Danh sách Danh mục</h3>
    <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>Tên Danh mục</th>
            <th>Hình ảnh</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody id="category-table-body">
        </tbody>
    </table>
</div>

<script>
    // URL của API endpoint
    const API_URL = '/api/category';

    const categoryForm = document.getElementById('category-form');
    const categoryIdField = document.getElementById('categoryId');
    const categoryNameField = document.getElementById('categoryName');
    const iconField = document.getElementById('icon');
    const formTitle = document.getElementById('form-title');
    const cancelBtn = document.getElementById('cancel-btn');

    // Hàm để tải và hiển thị danh sách category
    async function loadCategories() {
        try {
            const response = await fetch(API_URL);
            const result = await response.json();

            if (result.status === true) {
                const categories = result.body;
                const tableBody = document.getElementById('category-table-body');
                tableBody.innerHTML = ''; // Xóa dữ liệu cũ

                categories.forEach(cat => {
                    const row = `
                        <tr>
                            <td>${cat.id}</td>
                            <td>${cat.categoryName}</td>
                            <td>
                                <img src="/images/${cat.images}" alt="${cat.categoryName}" class="icon-preview">
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editCategory(${cat.id}, '${cat.categoryName}')">Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">Xóa</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } else {
                alert('Lỗi khi tải danh sách: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Đã xảy ra lỗi khi kết nối tới server.');
        }
    }

    // Xử lý sự kiện submit form (cho cả thêm mới và cập nhật)
    categoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = categoryIdField.value;
        const categoryName = categoryNameField.value;
        const iconFile = iconField.files[0];

        // Dùng FormData để gửi file và dữ liệu text
        const formData = new FormData();
        formData.append('categoryName', categoryName);

        if (iconFile) {
            formData.append('icon', iconFile);
        }

        let url = API_URL + '/addCategory';
        let method = 'POST';

        // Nếu có ID, đây là chế độ cập nhật
        if (id) {
            url = API_URL + '/updateCategory';
            method = 'PUT';
            formData.append('categoryId', id);
        }

        try {
            const response = await fetch(url, {
                method: method,
                body: formData
            });

            const result = await response.json();
            alert(result.message);

            if (result.status === true) {
                resetForm();
                loadCategories(); // Tải lại danh sách
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Đã xảy ra lỗi khi gửi dữ liệu.');
        }
    });

    // Hàm để đưa thông tin category lên form để sửa
    function editCategory(id, name) {
        categoryIdField.value = id;
        categoryNameField.value = name;
        formTitle.textContent = 'Cập nhật Danh mục';
        cancelBtn.style.display = 'inline-block';
        window.scrollTo(0, 0); // Cuộn lên đầu trang
    }

    // Hàm xóa category
    async function deleteCategory(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa danh mục này không?')) {
            return;
        }

        const formData = new FormData();
        formData.append('categoryId', id);

        try {
            const response = await fetch(API_URL + '/deleteCategory', {
                method: 'DELETE',
                body: formData
            });

            const result = await response.json();
            alert(result.message);

            if (result.status === true) {
                loadCategories(); // Tải lại danh sách
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Đã xảy ra lỗi khi xóa.');
        }
    }

    // Hàm để reset form
    function resetForm() {
        categoryForm.reset();
        categoryIdField.value = '';
        formTitle.textContent = 'Thêm Danh mục mới';
        cancelBtn.style.display = 'none';
    }

    // Gắn sự kiện cho nút Cancel
    cancelBtn.addEventListener('click', resetForm);

    // Tải danh sách category khi trang được mở lần đầu
    document.addEventListener('DOMContentLoaded', loadCategories);

</script>
</body>
</html>